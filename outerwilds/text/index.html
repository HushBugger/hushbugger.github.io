<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Outer Wilds text dump</title>
    <style>
      body {
          color: black;
          font-family: sans-serif;
          margin: 0px;
      }
      div.intro {
          background: white;
          color: black;
          padding: 0.4em;
      }
      div.section {
          padding: 0.4em;
      }
      a.label {
          font-size: 0.7em;
          font-family: monospace;
          color: #666;
          text-decoration: none;
      }
      div.message {
          padding: 2px;
          overflow-wrap: anywhere;
      }
      span.orange {
          color: #960;
      }
      span.red {
          color: #d00;
      }
      span.grey {
          color: grey;
      }
      span.lightblue {
          color: #48a;
      }
      span.small {
          font-size: 0.7rem;
      }
      span.big {
          font-size: 2rem;
      }
      span.template {
          font-family: monospace;
          font-size: 1.2em;
      }

      body.solarized {
          background: #144040;
          color: #b1eaea;
      }
      body.solarized div.message {
          font-family: monospace;
          font-size: 1.2em;
      }
      body.solarized a.label {
          color: #7bbfbf;
      }
      body.solarized span.orange {
          color: #d9ae53;
      }
      body.solarized span.lightblue {
          color: #aed0d8;
      }
      body.solarized span.red {
          color: #f31;
      }
      body.solarized span.template {
          font-size: 1em;
      }
    </style>
  </head>
  <body>
    <div class="intro">
      <p>This page spoils the entirety of Outer Wilds, including the DLC.</p>
      <p>The game is much less fun if it's been spoiled.</p>
      <p>If you haven't finished it, stay away!</p>
      <p>
        <input id="solarized" type="checkbox" name="solarized" checked="checked">
        <label for="solarized">Solarized</label>
      </p>
      <p>
        <select id="characters" name="characters">
          <option value="">Select a character...</option>
          <optgroup label="Groups">
            <option value="Hearthians">Hearthians</option>
            <option value="Nomai">Nomai</option>
            <option value="Game text">Game text</option>
          </optgroup>
          <optgroup label="Travelers">
            <option value="Chert">Chert</option>
            <option value="Esker">Esker</option>
            <option value="Feldspar">Feldspar</option>
            <option value="Gabbro">Gabbro</option>
            <option value="Riebeck">Riebeck</option>
            <option value="Solanum">Solanum</option>
            <option value="Prisoner">Prisoner</option>
            <option value="Self">Self</option>
          </optgroup>
          <optgroup label="Hearthians">
            <option value="Arkose">Arkose</option>
            <option value="Galena">Galena</option>
            <option value="Gneiss">Gneiss</option>
            <option value="Gossan">Gossan</option>
            <option value="Hal">Hal</option>
            <option value="Hornfels">Hornfels</option>
            <option value="Marl">Marl</option>
            <option value="Mica">Mica</option>
            <option value="Moraine">Moraine</option>
            <option value="Porphy">Porphy</option>
            <option value="Rutile">Rutile</option>
            <option value="Slate">Slate</option>
            <option value="Spinel">Spinel</option>
            <option value="Tektite">Tektite</option>
            <option value="Tephra">Tephra</option>
            <option value="Tuff">Tuff</option>
          </optgroup>
          <optgroup label="Nomai">
            <option value="Annona">Annona</option>
            <option value="Avens">Avens</option>
            <option value="Bells">Bells</option>
            <option value="Bromi">Bromi</option>
            <option value="Bur">Bur</option>
            <option value="Canna">Canna</option>
            <option value="Cassava">Cassava</option>
            <option value="Clary">Clary</option>
            <option value="Clem">Clem</option>
            <option value="Coleus">Coleus</option>
            <option value="Conoy">Conoy</option>
            <option value="Cycad">Cycad</option>
            <option value="Daz">Daz</option>
            <option value="Din">Din</option>
            <option value="Escall">Escall</option>
            <option value="Filix">Filix</option>
            <option value="Hyssop">Hyssop</option>
            <option value="Idaea">Idaea</option>
            <option value="Ilex">Ilex</option>
            <option value="Kousa">Kousa</option>
            <option value="Laevi">Laevi</option>
            <option value="Lami">Lami</option>
            <option value="Mallow">Mallow</option>
            <option value="Melorae">Melorae</option>
            <option value="Mitis">Mitis</option>
            <option value="Neem">Neem</option>
            <option value="Oeno">Oeno</option>
            <option value="Phlox">Phlox</option>
            <option value="Plume">Plume</option>
            <option value="Poke">Poke</option>
            <option value="Privet">Privet</option>
            <option value="Pye">Pye</option>
            <option value="Ramie">Ramie</option>
            <option value="Rhus">Rhus</option>
            <option value="Root">Root</option>
            <option value="Secca">Secca</option>
            <option value="Spire">Spire</option>
            <option value="Taget">Taget</option>
            <option value="Thatch">Thatch</option>
            <option value="Yarrow">Yarrow</option>
            <option value="Unknown Nomai">Unknown Nomai</option>
            <option value="Nomai computer">Nomai computer</option>
            <option value="Nomai sign">Nomai sign</option>
          </optgroup>
          <optgroup label="Other">
            <option value="Easter egg">Easter egg</option>
            <option value="Ending">Ending</option>
            <option value="Exhibit">Exhibit</option>
            <option value="Eye">Eye</option>
            <option value="Gravestone">Gravestone</option>
            <option value="Notes">Notes</option>
            <option value="Projector">Projector</option>
            <option value="Ship Log">Ship Log</option>
            <option value="Sign">Sign</option>
            <option value="Translator">Translator</option>
            <option value="UI">UI</option>
          </optgroup>
        </select>
      </p>
      <p>
        <select id="language" name="language">
          <option value="en">English</option>
          <option value="cn">Chinese</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="it">Italian</option>
          <option value="jp">Japanese</option>
          <option value="ko">Korean</option>
          <option value="pl">Polish</option>
          <option value="pt">Portuguese</option>
          <option value="ru">Russian</option>
          <option value="es">Spanish</option>
          <option value="tr">Turkish</option>
        </select>
      </p>
    </div>
    <noscript>
      <p>Sorry, but this page requires JavaScript.</p>
    </noscript>
    <div id="messages">
    </div>
    <script>
      "use strict";

      if (localStorage.getItem("owSolarized") === "no") {
          solarized.checked = false;
      } else {
          solarized.checked = true;
          document.body.classList.add("solarized");
      }
      solarized.addEventListener("change", function() {
          if (solarized.checked) {
              document.body.classList.add("solarized");
              localStorage.setItem("owSolarized", "yes");
          } else {
              document.body.classList.remove("solarized");
              localStorage.setItem("owSolarized", "no");
          }
      });

      // Lots of manual state management here.
      // I think it's mostly correct, but it's not easy to follow.

      let authorsInited = false;
      let translations = {};

      let curLang = null;
      let curFilter = null;

      let lang = "en";
      let filter = "";

      let needHashJump = true;

      function groupvals(group) {
          return [
              ...document.querySelector(`optgroup[label="${group}"]`)
                  .getElementsByTagName("option")
          ].map(x => x.value);
      }

      const groups = new Map([
          ["Nomai", [...groupvals("Nomai"), "Solanum"]],
          ["Hearthians", [
              ...groupvals("Hearthians"),
              "Chert", "Esker", "Feldspar", "Gabbro", "Riebeck", "Self",
              "Exhibit", "Notes", "Projector", "Sign",
          ]],
          ["Game text", ["Ending", "Ship Log", "UI"]],
      ]);

      function parseHash() {
          lang = "en";
          filter = "";
          let hash = document.location.hash.slice(1);
          if (hash && !"1234567890".includes(hash[0])) {
              if (hash[0] === '[') {
                  lang = hash.slice(1, 3);
                  hash = hash.slice(4);
              }
              if (hash && !"1234567890".includes(hash[0])) {
                  filter = hash.split('#')[0].replace("%20", " ");
              }
          }
          updateFilterDropdown();
          updateLangDropdown();
      }

      parseHash();
      render();

      function render() {
          if (lang === curLang && filter === curFilter) {
              return;
          }

          let translation = translations[lang];
          if (!translation) {
              messages.innerHTML = `
              <div class="section">
                  <div class="message">Loading...</div>
              </div>
              `;

              function failed() {
                  messages.innerHTML = `
                  <div class="section">
                    <div class="message">
                      <span class="red">ERROR: Transmission Failed</span>
                    </div>
                  </div>
                  `;
              }

              let req = new XMLHttpRequest;
              req.addEventListener("load", function() {
                  try {
                      translations[lang] = JSON.parse(this.responseText);
                  } catch (e) {
                      failed();
                      return;
                  }
                  render();
              });
              req.addEventListener("error", failed);
              req.addEventListener("abort", failed);
              req.open("GET", `lang_${lang}.json`);
              req.send();
              return;
          }

          let authors = filter && new Set(groups.get(filter) || [filter]);

          messages.innerHTML = "";

          let last = null;
          let current = null;
          let didFind = false;
          for (let id of Object.keys(translation)) {
              // `author` matters for filtering
              // `label` is displayed
              // player options are filtered according to the conversation
              // partner but displayed as "Me"
              let [message, author, label] = translation[id];
              label = label || author;
              if (authors && !authors.has(author)) {
                  continue;
              }
              didFind = true;
              id = id.toString();
              if (filter) {
                  id = `${filter}#${id}`;
              }
              if (lang !== "en") {
                  id = `[${lang}]${id}`;
              }
              let did_label = false;
              if (label !== last) {
                  current = document.createElement("div");
                  current.classList.add("section");

                  let lab = document.createElement("a");
                  lab.classList.add("label");
                  lab.innerText = label;
                  lab.id = id;
                  lab.href = `#${id}`;

                  current.appendChild(lab);
                  messages.appendChild(current);
                  did_label = true;
              }
              last = label;

              let msg = document.createElement("div");
              msg.classList.add("message");
              if (!did_label) {
                  msg.id = id;
              }
              msg.innerHTML = message;
              current.appendChild(msg);
          }
          curLang = lang;
          curFilter = filter;
          if (!didFind) {
              filter = "";
              updateHash();
              render();
              return;
          }
          if (needHashJump) {
              document.location.hash = document.location.hash;
          }
      }

      function updateHash() {
          let hash = "#";
          if (lang !== "en") {
              hash += `[${lang}]`;
          }
          if (filter !== "") {
              hash += filter;
          }
          document.location.hash = hash;
      }

      function updateFilterDropdown() {
          for (let option of characters.options) {
              if (option.value === filter) {
                  if (!option.selected) {
                      // I'm paranoid about update loops
                      option.selected = true;
                  }
                  break;
              }
          }
      }

      function updateLangDropdown() {
          for (let option of language.options) {
              if (option.value === lang) {
                  if (!option.selected) {
                      option.selected = true;
                  }
                  break;
              }
          }
      }

      characters.addEventListener("change", function() {
          filter = characters.selectedOptions[0].value;
          render();
          updateHash();
      });

      language.addEventListener("change", function() {
          lang = language.selectedOptions[0].value;
          render();
          updateHash();
      });

      window.addEventListener("hashchange", function() {
          parseHash();
          needHashJump = true;
          render();
      });
    </script>
  </body>
</html>
