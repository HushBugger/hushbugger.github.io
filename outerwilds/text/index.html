<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Outer Wilds text dump</title>
    <style type="text/css">
      body {
          color: black;
          font-family: sans-serif;
          margin: 0px;
      }
      div.intro {
          background: white;
          color: black;
          padding: 0.4em;
      }
      div.section {
          padding: 0.4em;
      }
      a.label {
          font-size: 0.7em;
          font-family: monospace;
          color: #666;
          text-decoration: none;
      }
      div.message {
          padding: 2px;
          overflow-wrap: anywhere;
      }
      span.orange {
          color: #960;
      }
      span.red {
          color: #d00;
      }
      span.grey {
          color: grey;
      }
      span.lightblue {
          color: #48a;
      }
      span.small {
          font-size: 0.7rem;
      }
      span.big {
          font-size: 2rem;
      }
      span.template {
          font-family: monospace;
          font-size: 1.2em;
      }

      body.solarized {
          background: #144040;
          color: #b1eaea;
      }
      body.solarized div.message {
          font-family: monospace;
          font-size: 1.2em;
      }
      body.solarized a.label {
          color: #7bbfbf;
      }
      body.solarized span.orange {
          color: #d9ae53;
      }
      body.solarized span.lightblue {
          color: #aed0d8;
      }
      body.solarized span.red {
          color: #f31;
      }
    </style>
  </head>
  <body>
    <div class="intro">
      <p>This page spoils the entirety of Outer Wilds.</p>
      <p>The game is much less fun if it's been spoiled.</p>
      <p>If you haven't finished it, stay away!</p>
      <p>
        <input id="solarized" type="checkbox" name="solarized" checked="true">
        <label for="solarized">Solarized</label>
      </p>
      <p>
        <select id="characters" name="characters">
          <option value="">Select a character...</option>
        </select>
      </p>
      <p>
        <select id="language" name="language">
          <option value="en">English</option>
          <option value="cn">Chinese</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="it">Italian</option>
          <option value="jp">Japanese</option>
          <option value="ko">Korean</option>
          <option value="pl">Polish</option>
          <option value="pt">Portuguese</option>
          <option value="ru">Russian</option>
          <option value="es">Spanish</option>
          <option value="tr">Turkish</option>
        </select>
      </p>
    </div>
    <noscript>
      <p>Sorry, but this page requires JavaScript.</p>
    </noscript>
    <div id="messages">
    </div>
    <script>
      "use strict";

      if (localStorage.getItem("owSolarized") === "no") {
          solarized.checked = false;
      } else {
          solarized.checked = true;
          document.body.classList.add("solarized");
      }
      solarized.addEventListener("change", function() {
          if (solarized.checked) {
              document.body.classList.add("solarized");
              localStorage.setItem("owSolarized", "yes");
          } else {
              document.body.classList.remove("solarized");
              localStorage.setItem("owSolarized", "no");
          }
      });

      let authorsInited = false;
      let translations = {};

      let curLang = null;
      let curFilter = null;

      let lang = "en";
      let filter = "";

      let needHashJump = true;

      function parseHash() {
          lang = "en";
          filter = "";
          let hash = document.location.hash.slice(1);
          if (hash && !"1234567890".includes(hash[0])) {
              if (hash[0] === '[') {
                  lang = hash.slice(1, 3);
                  hash = hash.slice(4);
              }
              if (!"1234567890".includes(hash[0])) {
                  [filter] = hash.split('#');
              }
          }
          updateLangDropdown();
      }

      parseHash();
      render();

      function render() {
          if (lang === curLang && filter === curFilter) {
              return;
          }

          let translation = translations[lang];
          if (!translation) {
              messages.innerHTML = `
              <div class="section">
                  <div class="message">Loading...</div>
              </div>
              `;

              function failed() {
                  messages.innerHTML = `
                  <div class="section">
                    <div class="message">
                      <span class="red">ERROR: Transmission Failed</span>
                    </div>
                  </div>
                  `;
              }

              let req = new XMLHttpRequest;
              req.addEventListener("load", function() {
                  try {
                      translations[lang] = JSON.parse(this.responseText);
                  } catch (e) {
                      failed();
                      return;
                  }
                  render();
              });
              req.addEventListener("error", failed);
              req.addEventListener("abort", failed);
              req.open("GET", `lang_${lang}.json`);
              req.send();
              return;
          }

          messages.innerHTML = "";

          let last = null;
          let current = null;
          const authors = new Set;
          for (let id of Object.keys(translation)) {
              let [message, author, label] = translation[id];
              label = label || author;
              if (!authorsInited) {
                  authors.add(author);
              }
              if (filter && author !== filter) {
                  continue;
              }
              id = id.toString();
              if (filter) {
                  id = `${filter}#${id}`;
              }
              if (lang !== "en") {
                  id = `[${lang}]${id}`;
              }
              let did_label = false;
              if (label !== last) {
                  current = document.createElement("div");
                  current.classList.add("section");

                  let lab = document.createElement("a");
                  lab.classList.add("label");
                  lab.innerText = label;
                  lab.id = id;
                  lab.href = `#${id}`;

                  current.appendChild(lab);
                  messages.appendChild(current);
                  did_label = true;
              }
              last = label;

              let msg = document.createElement("div");
              msg.classList.add("message");
              if (!did_label) {
                  msg.id = id;
              }
              msg.innerHTML = message;
              current.appendChild(msg);
          }
          curLang = lang;
          curFilter = filter;
          if (!authorsInited) {
              for (let author of [...authors].sort()) {
                  if (author === "?") {
                      continue;
                  }
                  let option = document.createElement("option");
                  option.value = author;
                  option.appendChild(document.createTextNode(author));
                  characters.options.add(option);
              }
              authorsInited = true;
          }
          let didFind = false;
          for (let option of characters.options) {
              if (option.value === filter) {
                  option.selected = true;
                  didFind = true;
                  break;
              }
          }
          if (!didFind) {
              filter = "";
              updateHash();
              render();
              return;
          }
          if (needHashJump) {
              document.location.hash = document.location.hash;
          }
      }

      function updateHash() {
          let hash = "#";
          if (lang !== "en") {
              hash += `[${lang}]`;
          }
          if (filter !== "") {
              hash += filter;
          }
          document.location.hash = hash;
      }

      function updateLangDropdown() {
          for (let option of language.options) {
              if (option.value === lang) {
                  option.selected = true;
                  break;
              }
          }
      }

      updateLangDropdown();

      characters.addEventListener("change", function() {
          filter = characters.selectedOptions[0].value;
          render();
          updateHash();
      });

      language.addEventListener("change", function() {
          lang = language.selectedOptions[0].value;
          render();
          updateHash();
      });

      window.addEventListener("hashchange", function() {
          parseHash();
          needHashJump = true;
          render();
      });
    </script>
  </body>
</html>
